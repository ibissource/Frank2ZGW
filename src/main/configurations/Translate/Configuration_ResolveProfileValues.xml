<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="ResolveProfileValues"
        active="${ResolveProfileValues.Active}"
        description="">

        <Receiver name="ResolveProfileValues">
            <JavaListener name="ResolveProfileValues" returnedSessionKeys="Error" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <Cache />

            <LocalFileSystemPipe name="ReadFile" action="read">
                <Param name="filename" value="${configurations.directory}/Translate/Profiles.json" />
            </LocalFileSystemPipe>

            <JsonPipe name="JsonToXml" />

            <XsltPipe name="renameProfileElement"
                styleSheetName="BaseProfile\RenameProfileElement.xsl"
                storeResultInSessionKey="profiles" 
                />

            <ForEachChildElementPipe
                name="AddPathAttributeToEachProfile"
                getInputFromSessionKey="profiles"
                >
                <XsltSender
                    styleSheetName="BaseProfile\AddPathAttribute.xsl"
                    indentXml="true"
                    omitXmlDeclaration="true"
                    >
                </XsltSender>
            </ForEachChildElementPipe>

            <XsltPipe
                name="RemoveResultTags"
                styleSheetName="BaseProfile\RemoveResultTags.xsl"
                storeResultInSessionKey="profiles" 
                />

            <XsltPipe
                name="ExtractBaseProfile"
                xpathExpression="root/profile[not(zaakTypeIdentificatie)]"
                omitXmlDeclaration="true"
                storeResultInSessionKey="baseProfile"
                outputType="XML"
                >
            </XsltPipe>


            <!-- If no baseprofile, return original input. 
            If multiple baseprofiles, report with an error.
            Otherwise, continue. -->
            <XmlWellFormedCheckerPipe name="checkBaseProfile">
                <Forward name="success" path="checkBaseProfilePresent" />
                <Forward name="failure" path="NoBaseProfile" />
            </XmlWellFormedCheckerPipe>

            <XmlIfPipe name="checkBaseProfilePresent" xpathExpression="count(//profile) = 0">
                <Forward name="then" path="NoBaseProfile" />
                <Forward name="else" path="checkBaseProfileCount" />
            </XmlIfPipe>

            <EchoPipe name="NoBaseProfile" getInputFromSessionKey="profiles">
                <Forward name="success" path="EXIT" />
            </EchoPipe>

            <FixedResultPipe name="MultipleBaseProfileError"
                returnString="Error: Multiple Baseprofiles defined">
                <Forward name="success" path="EXCEPTION" />
            </FixedResultPipe>


            
            <ForEachChildElementPipe 
                name="AddBaseProfileToEachProfile"
                getInputFromSessionKey="profiles"
                >
                <XsltSender 
                    styleSheetName="BaseProfile\AddBaseProfile.xsl" 
                    indentXml="true"
                    omitXmlDeclaration="true"
                    >
                    <Param name="baseProfile" sessionKey="baseProfile" type="DOMDOC" />
                </XsltSender>
            </ForEachChildElementPipe>

            <XsltPipe name="RemoveResultTags2" styleSheetName="BaseProfile\RemoveResultTags.xsl" />
            <XsltPipe name="RemovePathAttribute" styleSheetName="BaseProfile\RemovePathAttribute.xsl" />
            <XsltPipe name="resetProfileElementName" styleSheetName="BaseProfile\ResetProfileElementName.xsl" />
        </Pipeline>
    </Adapter>
</Module>