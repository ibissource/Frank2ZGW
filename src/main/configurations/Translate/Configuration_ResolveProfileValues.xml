<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="ResolveProfileValues"
        active="${ResolveProfileValues.Active}"
        description="">

        <Receiver name="ResolveProfileValues">
            <JavaListener name="ResolveProfileValues" returnedSessionKeys="Error" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <Cache />
            <LocalFileSystemPipe name="ReadFile" action="read">
                <Param name="filename" value="${configurations.directory}/Translate/Profiles.json" />
            </LocalFileSystemPipe>

            <JsonPipe name="JsonToXml" storeResultInSessionKey="profiles" />

            <ForEachChildElementPipe name="AddPathAttributeToEachProfile"
                getInputFromSessionKey="profiles" targetElement="profile">
                <XsltSender styleSheetName="Common\xsl\AddPathAttribute.xsl" indentXml="true"
                    omitXmlDeclaration="true">
                </XsltSender>
            </ForEachChildElementPipe>

            <XsltPipe name="RemoveResultTags" styleSheetName="Common\xsl\RemoveResultTags.xsl"
                storeResultInSessionKey="profiles" />

            <XsltPipe name="ExtractBaseProfile" styleSheetName="Common\xsl\ExtractBaseProfile.xsl"
                omitXmlDeclaration="true" storeResultInSessionKey="baseProfile" outputType="XML">
            </XsltPipe>

            <XmlWellFormedCheckerPipe name="checkBaseProfile">
                <Forward name="success" path="AddBaseProfileToEachProfile" />
                <Forward name="failure" path="NoBaseProfile" />
            </XmlWellFormedCheckerPipe>

            <EchoPipe name="NoBaseProfile" getInputFromSessionKey="profiles">
                <Forward name="success" path="EXIT" />
            </EchoPipe>

            <XmlIfPipe name="checkBaseProfile" xpathExpression="count(//profile) &gt; 1">
                <Forward name="then" path="AddBaseProfileToEachProfile" />
                <Forward name="else" path="MultipleBaseProfileError" />
            </XmlIfPipe>

            <FixedResultPipe name="MultipleBaseProfileError"
                returnString="Error: Multiple Baseprofiles defined">
                <Forward name="success" path="EXCEPTION" />
            </FixedResultPipe>

            <ForEachChildElementPipe name="AddBaseProfileToEachProfile"
                getInputFromSessionKey="profiles" targetElement="profile">
                <XsltSender styleSheetName="Common\xsl\AddBaseProfile.xsl" indentXml="true"
                    omitXmlDeclaration="true">
                    <Param name="baseProfile" sessionKey="baseProfile" type="DOMDOC" />
                </XsltSender>
            </ForEachChildElementPipe>

            <XsltPipe name="RemoveResultTags2" styleSheetName="Common\xsl\RemoveResultTags.xsl" />
            <XsltPipe name="RemovePathAttribute" styleSheetName="Common\xsl\RemovePathAttribute.xsl" />
        </Pipeline>
    </Adapter>
</Module>