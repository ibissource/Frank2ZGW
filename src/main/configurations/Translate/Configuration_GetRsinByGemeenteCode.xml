<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="GetRsinByGemeenteCode"
        active="${GetRsinByGemeenteCode.Active}"
        description="">

        <Receiver name="GetRsinByGemeenteCode">
            <JavaListener name="GetRsinByGemeenteCode"/>
        </Receiver>
        
        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS"/>
                <Exit name="EXCEPTION" state="ERROR"/>
            </Exits>

            <PutInSessionPipe
                name="GetRsin">
                <Param name="Rsin" xpathExpression="/root/organizations[gemeenteCode = $GemeenteCode]/RSIN" defaultValue="&lt;RSIN/&gt;" type="XML">
                    <Param name="GemeenteCode" sessionKey="GemeenteCode"/>
                </Param>
                <Forward name="success" path="Rsin_NotEmpty"/>
                <Forward name="error" path="EXCEPTION" />
            </PutInSessionPipe>

            <XmlIfPipe 
                name="Rsin_NotEmpty"
                getInputFromSessionKey="Rsin"
                xpathExpression="string-length(/RSIN) &gt; 0"
                >
                <Forward name="then" path="EXIT"/>
                <Forward name="else" path="CheckTheError"/>
                <Forward name="error" path="EXCEPTION"/>
            </XmlIfPipe>

            <IsXmlPipe name="CheckTheError">
                <Forward name="then" path="storeErrorMessage" />
                <Forward name="else" path="storeDummyErrorMessage" />
            </IsXmlPipe>

            <PutInSessionPipe name="storeErrorMessage">
                <Param name="error" xpathExpression="/error" />
                <Forward name="then" path="Rsin_NotEmpty_Exception" />
            </PutInSessionPipe>

            <PutInSessionPipe name="storeDummyErrorMessage">
                <Param name="error" value="&lt;dummy/&gt;"/>
                <Forward name="then" path="Rsin_NotEmpty_Exception" />
            </PutInSessionPipe>

            <XsltPipe 
                name="Rsin_NotEmpty_Exception"
                styleSheetName="Common/xsl/BuildError.xsl">
                <Param name="cause" sessionKey="error" type="DOMDOC" />
                <Param name="code" value="ConfigurationError" /> <!-- codes: TechnicalError, TranslationError, ConfigurationError-->
                <Param name="GemeenteCode" sessionKey="GemeenteCode"/>
                <Param name="reason" pattern="No organization configured for gemeente code: [{GemeenteCode}]" ignoreUnresolvablePatternElements="true"/> 
                <!-- <Param name="details" sessionKey="" /> -->
                <Param name="detailsXml" sessionKey="originalMessage" type="DOMDOC" />
                <Forward name="success" path="EXCEPTION" />
                <Forward name="error" path="EXCEPTION" />
            </XsltPipe>
        </Pipeline>
    </Adapter>
</Module>