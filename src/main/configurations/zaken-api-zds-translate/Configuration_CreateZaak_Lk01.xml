<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="CreateZaak_Lk01"
        active="${CreateZaak_Lk01.Active}"
        description="">

        <Receiver name="CreateZaak_Lk01">
            <JavaListener name="CreateZaak_Lk01"/>
            <JdbcErrorStorage
                name="JdbcErrorStorage"
                datasourceName="jdbc/${database.instance.name}"
                slotId="${instance.name}/createZaak_Lk01"/>
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="EXIT" state="SUCCESS"/>
                <Exit name="EXCEPTION" state="ERROR"/>
            </Exits>
            <UUIDGeneratorPipe name="generateUuid" storeResultInSessionKey="uuid" >
            	<Forward name="success" path="CallGetZgwZaakType"/>
            </UUIDGeneratorPipe>
            
            <!-- <XsltPipe
                name="Create Request"
                getInputFromSessionKey="originalMessage"
                styleSheetName="CreateZaak_LK01/xsl/CreateReqZaakType.xsl">
                <Param name="dateTime" pattern="{now,date,yyyy-MM-dd'T'HH:mm:ss:SSS}" />
                <Param name="ZaakTypeCode" xpathExpression="//zakLa01//object/isVan/gerelateerde/code"/> 
                <Param name="uuid" sessionKey="uuid"/> 
                <Forward name="success" path="CallGetZgwZaakType"/>
            </XsltPipe> -->
			

            <!-- <SenderPipe
                name="CallGetZdsZaakType"
                storeResultInSessionKey="GetZaakTypeResult">
                
                <IbisLocalSender
                    name="CallGetZdsZaakTypeSender"
                    javaListener="GetZdsZaakTypeByIdentificatie">
                    
                </IbisLocalSender>
                <Forward name="success" path="EXIT"/>
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe> -->
            
            <SenderPipe
                name="CallGetZgwZaakType"
                storeResultInSessionKey="GetZaakTypeResult">
                <IbisLocalSender
                    name="CallGetZgwZaakTypeSender"
                    javaListener="GetZgwZaakTypeByIdentificatie">
                    <Param name="ZaakTypeCode" xpathExpression="//zakLa01//object/isVan/gerelateerde/code" sessionKey="originalMessage"/>
                </IbisLocalSender>
                <Forward name="success" path="SetZgwZaakType"/>
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>

            <XsltPipe
                name="SetZgwZaakType"
                styleSheetName="CreateZaak_LK01/xsl/FilterZdsZaakTypenForGeldigheid.xsl"
                storeResultInSessionKey="GetZaakTypeResult"
                >
                <Forward name="success" path="CheckForSetZdsZaakTypeResult"/>
            </XsltPipe>

            <XmlIfPipe name="CheckForSetZdsZaakTypeResult"
                xpathExpression="count(/ZdsZaakTypen/ZdsZaakType) = 1"
                >
                <Forward name="then" path="GetGlobalConfigFromLocalFS"/>
                <Forward name="else" path="EXCEPTION"/>
            </XmlIfPipe>

            <SenderPipe name="GetGlobalConfigFromLocalFS">
                <IbisLocalSender
                    name="CallImportFromLocalFS"
                    javaListener="ImportFromLocalFS">
                    <Param name="FileName" value="${FilePath_1}"/>                   
                </IbisLocalSender>
                <Forward name="success" path="GetRsin"/>
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>

            <XsltPipe
                name="GetRsin"
                storeResultInSessionKey="GetRsinResult"
                skipEmptyTags="true"
                styleSheetName="CreateZaak_LK01/xsl/GetRsin.xsl"
                >
                <Param name="GemeenteCode" xpathExpression="$OriginalMessage/zakLk01/stuurgegevens/zender/organisatie">
                    <Param name="OriginalMessage" sessionKey="originalMessage" type="DOMDOC"/>
                </Param>
                <Forward name="success" path="CreateZaakBody"/>
            </XsltPipe>

            <!-- <SenderPipe
                name="CallGetZdsRolType"
                storeResultInSessionKey="ZdsRolTypen">
                <IbisLocalSender
                    name="GetZdsRolTypeByZaakTypeLocalSender"
                    javaListener="Zaken_GetZdsRolTypeByZaakType">
                    <Param name="ZaakTypeUrl" xpathExpression="$GetZaakTypeResult/ZdsZaakTypen/ZdsZaakType/url">
                        <Param name="GetZaakTypeResult" sessionKey="GetZaakTypeResult" type="DOMDOC"/>
                    </Param>
                </IbisLocalSender>
                <Forward name="success" path="SetRoles"/>
                <Forward name="exception" path="EXCEPTION" />
            </SenderPipe>   

            <XsltPipe
                name="SetRoles"
                getInputFromSessionKey="originalMessage"
                storeResultInSessionKey="RolBody"
                removeNamespaces="true"
                skipEmptyTags="true"
                styleSheetName="CreateZaak_LK01/xsl/SetRoles.xsl"
                >
                <Forward name="success" path="RolMappingIterator"/>
            </XsltPipe>
 
            <ForEachChildElementPipe name="RolMappingIterator"
                storeResultInSessionKey="RolMappingResults"
                elementXPathExpression="/roles/role"
                parallel="true">
                <IbisLocalSender
                    name="CallAddRolToZds"
                    javaListener="AddRolToZds">
                    <Param name="ZdsRolTypen" sessionKey="ZdsRolTypen" type="DOMDOC"/>
                    <Param name="ZaakTypeUrl" xpathExpression="$GetZaakTypeResult/ZdsZaakTypen/ZdsZaakType/url">
                        <Param name="GetZaakTypeResult" sessionKey="GetZaakTypeResult" type="DOMDOC"/>
                    </Param>
                </IbisLocalSender>
                <Forward name="success" path="CreateZaakBody"/>
                <Forward name="exception" path="EXCEPTION" />
            </ForEachChildElementPipe>
-->
            <XsltPipe
                name="CreateZaakBody"
                getInputFromSessionKey="originalMessage"
                storeResultInSessionKey="ZaakBody"
                removeNamespaces="true"
                skipEmptyTags="true"
                styleSheetName="CreateZaak_LK01/xsl/CreateZaakBody.xsl"
                >
                <Param name="GetZaakTypeResult" sessionKey="GetZaakTypeResult" type="DOMDOC"/>
                <Param name="GetRsinResult" sessionKey="GetRsinResult" type="DOMDOC"/>
                <Forward name="success" path="EXIT"/>
            </XsltPipe>

           
        </Pipeline>
    </Adapter>
</Module>