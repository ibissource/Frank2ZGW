<Module 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="../FrankConfig.xsd"
	>
	<Adapter 
		name="status_list"
		
		>
		<Receiver name="status_list">
			<ApiListener 
				name="status_list" 
				method="GET"
				uriPattern="/zaken/api/v1/statussen"
				produces="JSON"
				consumes="ANY"
				/>
		</Receiver>
		<Pipeline>
			<Exits>
				<Exit name="EXIT" state="SUCCESS" code="200"/>
				<Exit name="NotModified" state="SUCCESS" code="304"/>
				<Exit name="BadRequest" state="ERROR" code="400"/>
				<Exit name="NotAuthorized" state="ERROR" code="401" empty="true"/>
				<Exit name="NotAllowed" state="ERROR" code="403" empty="true"/>
				<Exit name="PreconditionFailed" state="ERROR" code="412"/>
				<Exit name="ServerError" state="ERROR" code="500"/>
				<Exit name="Timeout" state="ERROR" code="504"/>
			</Exits>

			<XsltPipe
                name="SetStatusUrl"
                styleSheetName="Common/xsl/CreateURL.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;"
                storeResultInSessionKey="UrlParam"
                >
                <Param name="BaseUrl" value="${zaakbrug.staging.zaken-api.root-url}" /> 
                <Param name="UrlParam" sessionKey="uri" /> 
                <Forward name="success" path="ExtractUUIDFromZaak"/>
            </XsltPipe>
            
            <XsltPipe
                name="ExtractUUIDFromZaak"
                styleSheetName="Common/xsl/UUID.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;"
                storeResultInSessionKey="uuid"
                >
                <Param name="zaak" sessionKey="zaak" /> 
                <Forward name="success" path="GetUUIDFromDB"/>
            </XsltPipe>
            
            <SenderPipe name="GetUUIDFromDB"
                storeResultInSessionKey="GetIdResult">
                <FixedQuerySender 
                    query="SELECT IDENTIFICATIE FROM ZAAKDETAILS WHERE UUID  = ?{uuid}" 
                    queryType="SELECT" 
                    />
                    <Param name="uuid" sessionKey="uuid"/>
	            <Forward name="success" path="CheckForDBResult" />
            </SenderPipe>
            
            <XmlIfPipe name="CheckForDBResult"
                xpathExpression="string-length(result/rowset/row[@number='0']) > 0"
                >
                <Forward name="then" path="Create Request"/>
                <Forward name="else" path="Error"/>
            </XmlIfPipe>
            
            <XsltPipe
                name="Create Request"
                styleSheetName="Common/xsl/CreateReq.xsl"
                getInputFromFixedValue="&lt;Dummy/&gt;">
                <Param name="dateTime" pattern="{now,date,yyyy-MM-dd'T'HH:mm:ss:SSS}" />
                <Param name="mode" value="status_list" />
                <Param name="zaak" sessionKey="zaak" />
                <Param name="Identificatie" xpathExpression="/result/rowset/row/field" sessionKey="GetIdResult" />
	            <Param name="omschrijving" sessionKey="omschrijving" /> 
                <Forward name="success" path="CallStatus_TranslationHandler"/>
            </XsltPipe>
            
            <SenderPipe
                name="CallStatus_TranslationHandler">
                <SoapInputWrapper ></SoapInputWrapper>
                <WsdlXmlInputValidator 
	                wsdl="../Translate/Common/xsd/Zaak_DocumentServices_1_1_02/zkn0310/zs-dms/zkn0310_beantwoordVraag_zs-dms.wsdl"
	                soapBody="zakLv01"
	                ignoreUndeclaredElements="true"
	                ignoreUnknownNamespaces="true"
	                >
					<Forward name="failure" path="Error"/>
	                <Forward name="parserError" path="Error"/>
				</WsdlXmlInputValidator>
                <IbisLocalSender
                    name="Status_TranslationHandler"
                    javaListener="Status_TranslationHandler">
                    <Param name="zaak" sessionKey="zaak" /> 
	                <Param name="omschrijving" sessionKey="omschrijving" /> 
	                <Param name="omschrijvingGeneriek" sessionKey="omschrijvingGeneriek" /> 
                	<Param name="uuid" sessionKey="uuid" /> 
	                
                </IbisLocalSender>
                <Forward name="success" path="XmlTOJson"/>
                <Forward name="exception" path="ServerError" />
            </SenderPipe>
             
            <FixedResultPipe name="Error"
				returnString="&lt;Error/&gt;" >
				<Forward name="success" path="XmlTOJson"/>
			</FixedResultPipe>
            
            <JsonPipe name="XmlTOJson" direction="XML2JSON">
                <Forward name="success" path="EXIT" />
            </JsonPipe>
		</Pipeline>
	</Adapter>
</Module>